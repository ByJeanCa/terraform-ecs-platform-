name: Destroy PR Infra

on:
  pull_request:
    types: [closed]

jobs:
  destroy-ecs-infra:
    runs-on: ubuntu-latest

    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::805206611903:role/github-actions-dev
          aws-region: us-east-1

      - name: Install Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_wrapper: false

      - name: Terraform init
        run: terraform init
        working-directory: live/dev/

      - name: Select PR workspace
        run: terraform workspace select "pr-${{ github.event.pull_request.number }}"
        working-directory: live/dev/

      - name: Get ECR repository name (from URL)
        working-directory: live/dev/
        run: |
          REPO_URI=$(terraform output -raw ecr_repository_url)
          ECR_REPO_NAME="${REPO_URI##*/}"
          echo "ECR_REPO_NAME=$ECR_REPO_NAME" >> $GITHUB_ENV


      - name: Delete all ECR images
        run: |
          aws ecr list-images \
            --repository-name "${{ env.ECR_REPO_NAME }}" \
            --query 'imageIds[*]' \
            --output json \
          | jq -c '.[]?' \
          | while read -r image; do
              aws ecr batch-delete-image \
                --repository-name "${{ env.ECR_REPO_NAME }}" \
                --image-ids "$image"
            done

      - name: Terraform destroy
        run: terraform destroy --auto-approve -var="environment=pr-${{ github.event.pull_request.number }}"
        working-directory: live/dev/

      - name: Delete PR workspace
        run: |
          terraform workspace select default 
          terraform workspace delete "pr-${{ github.event.pull_request.number }}"
        working-directory: live/dev/
